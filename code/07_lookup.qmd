---
title: "lookup hex-lad-msoa-lsoa"
format: html
editor: visual
---

```{r}
library(sf)
library(dplyr)
library(purrr)
library(h3r)   
library(arrow)   
library(ggplot2)
library(RANN) 
library(h3)
```

# Read data

```{r}
# lad  <- st_read("/Volumes/DEBIAS/data/inputs/geographies/boundaries/LAD_Dec_2021_GB_BFC_2022.gpkg") %>%
#   st_transform(4326)
# 
# msoa <- st_read("/Volumes/DEBIAS/data/inputs/geographies/boundaries/MSOA_Dec_2021_EW_BFC_V7.gpkg") %>%
#    st_transform(4326)

lsoa <- st_read("/Volumes/DEBIAS/data/inputs/geographies/boundaries/LSOA_Dec_2021_EW_BFC_V10.gpkg") %>%
   st_transform(4326)

# lsoa <- st_read("/Users/carmen/Documents/github/gds-cc/data/Liverpool/liv_lsoas.gpkg") %>%
#    st_transform(4326) %>%
#    dplyr::select(-c(MSOA11CD))

```

# Create hexagonal grid

## Making grid based on LSOAs and store corresponding LSOA21CD

```{r}
#--------------------------------------------
# Helper: drop repeated closing vertex if present
#--------------------------------------------
drop_closing_vertex <- function(mat) {
  if (nrow(mat) > 2 && all(mat[1, ] == mat[nrow(mat), ])) {
    mat <- mat[-nrow(mat), , drop = FALSE]
  }
  mat
}

#--------------------------------------------
# Helper: convert sfc object â†’ nested list structure for h3r::polygonToCells()
#--------------------------------------------
convert_sfc_to_list <- function(sfc) {
  sfc <- sf::st_cast(sfc, "MULTIPOLYGON", warn = FALSE)

  lapply(sfc, function(multipoly) {
    lapply(multipoly, function(poly) {
      # Build each ring
      rings <- lapply(poly, function(ring) {
        ring <- ring[, 1:2, drop = FALSE]  # keep lon, lat only
        ring <- drop_closing_vertex(ring)
        ring <- unique(ring, MARGIN = 1)
        if (nrow(ring) < 3) return(NULL)
        storage.mode(ring) <- "double"
        ring
      })

      # Remove NULL rings (too short etc.)
      Filter(Negate(is.null), rings)
    })
  })
}

#--------------------------------------------
# MAIN PIPELINE
#--------------------------------------------

# Make sure geometry is valid and in lon/lat (EPSG:4326)
lsoa <- lsoa |>
  st_make_valid() |>
  st_transform(4326) |>
  st_cast("MULTIPOLYGON", warn = FALSE)

# Build list-of-lists of coordinates
poly_list <- convert_sfc_to_list(st_geometry(lsoa))

# Compute H3 cells per feature (change 'res' as desired)
res <- 10
cell_list <- lapply(seq_len(nrow(lsoa)), function(i) {
  p <- poly_list[[i]]
  if (length(p) == 0) return(NULL)

  cell_ids <- unique(unlist(
    polygonToCells(p, resolution = res, isLatLng = FALSE),
    use.names = FALSE
  ))

  if (!length(cell_ids)) return(NULL)

  data.frame(
    LSOA21CD = lsoa$LSOA21CD[i],
    hex_id  = cell_ids,
    stringsAsFactors = FALSE
  )
})

# Combine results and remove duplicates
cell_map <- bind_rows(cell_list) |>
  distinct(LSOA21CD, hex_id)

# Convert unique hex IDs to sf geometry
hex_geom <- h3_to_geo_sf(unique(cell_map$hex_id)) |>
  rename(hex_id = h3_index) |>
  st_set_crs(4326)

# Join geometry back to LAD mapping
hex_sf <- cell_map |>
  left_join(hex_geom, by = "hex_id") |>
  st_as_sf()

#--------------------------------------------
# Replace hex polygons with centroids
#--------------------------------------------
hex_sf_centroids <- hex_sf |>
  mutate(geometry = st_centroid(geometry)) |>
  select(hex_id, LSOA21CD, geometry) |>
  st_set_crs(4326)

```

# Drop geometry

```{r}
lookup <- hex_sf_centroids %>%
  st_drop_geometry()
```

# Save csv

```{r}
write.csv(lookup, "/Volumes/DEBIAS/data/inputs/geographies/lookup21ew/hex10-lsoa-faster.csv")
```

# Add additional columns for MSOA, LAD

```{r}
lookup <- read.csv("/Volumes/DEBIAS/data/inputs/geographies/lookup21ew/hex10-lsoa-faster.csv")
```

```{r}
lookup <- lookup %>%
  dplyr::select(-c(X))
```


```{r}
lookup_admin <- read.csv("/Volumes/DEBIAS/data/inputs/geographies/lookup21ew/OA_to_LSOA_to_MSOA_to_LAD_Dec_2021_EW_V3.csv")
```


```{r}
lookup_admin_clean <- lookup_admin %>% 
  select(LSOA21CD, MSOA21CD) %>%
  distinct()

lookup_join <- lookup %>%
  left_join(
    lookup_admin_clean,
    by = "LSOA21CD"
  )

lookup_admin_clean <- lookup_admin %>% 
  select(MSOA21CD, LAD22CD) %>%
  distinct()

lookup_join <- lookup_join %>%
  left_join(
    lookup_admin_clean,
    by = "MSOA21CD"
  )
```

```{r}
write.csv(lookup_join, "/Volumes/DEBIAS/data/inputs/geographies/lookup21ew/hex10-lsoa-msoa-lad.csv")
```

