---
title: "Untitled"
format: html
editor: visual
---

```{r}
# Load the Arrow library
library(arrow)

# Define the root directory of your files
root_dir <- "/Volumes/rdm04/DEBIAS/data/inputs/pickwell/uk/01042021"

# Recursively list all .csv.gz files in the directory structure
all_files <- list.files(root_dir, pattern = "\\.csv\\.gz$", recursive = TRUE, full.names = TRUE)

# Combine all files into a single Arrow Table
combined_table <- NULL

for (file in all_files) {
  # Read each compressed file using Arrow
  data <- read_csv_arrow(file)
  
  # Append to combined table
  if (is.null(combined_table)) {
    combined_table <- data
  } else {
    combined_table <- rbind(combined_table, data)
  }
}

# Save combined data as a Parquet file (optional)
write_parquet(combined_table, file.path(root_dir, "combined_data.parquet"))

# Output the combined data for use in R
print(combined_table)
```

```{r}
# Replace the path with the location of your Parquet file
parquet_data <- read_parquet("/Volumes/rdm04/DEBIAS/data/inputs/pickwell/uk/01042021/combined_data.parquet")
```

```{r}
fhvhv_csv_files <- list.files("/Volumes/rdm04/DEBIAS/data/inputs/pickwell/uk/01042021", recursive=TRUE, full.names = TRUE)
data.frame(file = fhvhv_csv_files, size_Mb = file.size(fhvhv_csv_files) / 1024^2)
```

```{r}
if(!dir.exists("converted_parquet")) {
  
  dir.create("converted_parquet")}
  
  ## this doesn't yet read the data in, it only creates a connection
csv_ds <- open_dataset("/Volumes/rdm04/DEBIAS/data/inputs/pickwell/uk", 
                       format = "csv",
                       partitioning = c("day"))
  
  ## this reads each csv file in the csv_ds dataset and converts it to a .parquet file
  write_dataset(csv_ds, 
                "/Volumes/rdm04/DEBIAS/data/inputs/pickwell/uk/converted_parquet", 
                format = "parquet",
                partitioning = c("day"))



```
